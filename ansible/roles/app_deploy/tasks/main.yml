---
- name: Ensure Docker Python SDK >= 7.0 (fix http+docker scheme)
  ansible.builtin.pip:
    name: "docker>=7.0.0"
    state: present
  become: yes

- name: Log in to Docker Hub (via CLI to avoid SDK connection issues)
  ansible.builtin.shell: |
    echo "{{ dockerhub_password }}" | docker login -u "{{ dockerhub_username }}" --password-stdin
  no_log: true
  register: docker_login_out
  changed_when: "'Login Succeeded' in docker_login_out.stdout"
  failed_when: docker_login_out.rc != 0

- name: Pull Docker image
  ansible.builtin.command:
    cmd: docker pull "{{ docker_image }}:{{ docker_image_tag }}"
  register: docker_pull_out
  changed_when: docker_pull_out.rc == 0 and 'Image is up to date' not in docker_pull_out.stdout

- name: Stop and remove existing container
  ansible.builtin.shell: |
    docker stop "{{ app_container_name }}" 2>/dev/null || true
    docker rm "{{ app_container_name }}" 2>/dev/null || true
  changed_when: true

- name: Run application container
  ansible.builtin.shell: |
    docker run -d \
      --name "{{ app_container_name }}" \
      -p "{{ app_port }}:{{ app_port }}" \
      --restart "{{ restart_policy }}" \
      {% if app_env %}{% for k, v in app_env.items() %}-e "{{ k }}={{ v }}" {% endfor %}{% endif %}\
      "{{ docker_image }}:{{ docker_image_tag }}"
  args:
    executable: /bin/bash
  register: docker_run_out
  changed_when: docker_run_out.rc == 0
  failed_when: docker_run_out.rc != 0

- name: Wait for application port
  ansible.builtin.wait_for:
    port: "{{ app_port }}"
    host: "127.0.0.1"
    delay: 2
    timeout: 30
    state: started

- name: Verify health endpoint
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ app_port }}/health"
    status_code: 200
    timeout: 5
  register: health_check
  changed_when: false
  failed_when: health_check.status != 200
  ignore_errors: true
